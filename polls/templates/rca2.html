<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refined Forensic RCA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --apple-bg: #f5f5f7;
            --glass: rgba(255, 255, 255, 0.98);
            --blue: #007aff;
            --green: #24b244;
            --connector: #444446;
        }

        body { background-color: var(--apple-bg); font-family: -apple-system, sans-serif; padding: 20px; }
        .dashboard-container { max-width: 1300px; margin: auto; position: relative; }

        /* Flow SVG */
        #flow-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .connector { fill: none; stroke: var(--connector); stroke-width: 2; stroke-dasharray: 6; transition: 0.4s; }
        .line-hidden { opacity: 0; }

        /* Card Styling - Compact but Detailed */
        .apple-card {
            background: var(--glass); border-radius: 20px; border: 1px solid #fff;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05); z-index: 2;
            position: relative; margin-bottom: 40px; transition: 0.3s;
        }
        .collapse-btn { position: absolute; top: 12px; right: 12px; border: none; background: rgba(0,0,0,0.05); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }
        
        .details-content { max-height: 0; opacity: 0; transition: all 0.4s ease; overflow: hidden; }
        .details-content.expanded { max-height: 500px; opacity: 1; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.08); }

        /* List Styling */
        .ci-item { padding: 8px 12px; border-radius: 10px; cursor: pointer; background: rgba(0,0,0,0.03); margin-bottom: 6px; font-size: 0.85rem; display: flex; justify-content: space-between; }
        .ci-item.active { background: white; border: 1px solid var(--blue); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* Evidence & Fix Boxes */
        pre { font-size: 0.75rem; background: #1c1c1e; color: #ff6961; padding: 12px; border-radius: 10px; margin-bottom: 0; }
        .fix-highlight { background: rgba(36, 178, 68, 0.08); border: 1px dashed var(--green); border-radius: 12px; padding: 12px; font-size: 0.85rem; }
        .btn-execute { background: var(--green); color: white; border: none; width: 100%; padding: 8px; border-radius: 10px; font-weight: 600; font-size: 0.85rem; margin-top: 10px; }

        .label { font-size: 0.6rem; font-weight: 700; color: #86868b; text-transform: uppercase; margin-top: 8px; }
        .val { font-size: 0.85rem; color: #1d1d1f; font-weight: 500; }
    </style>
</head>
<body>

<div class="dashboard-container" id="main-canvas">
    <svg id="flow-canvas">
        <path id="line-1" class="connector" /> 
        <path id="line-2" class="connector" />
        <path id="line-bypass" class="connector line-hidden" />
        <path id="line-3" class="connector" />
        <path id="line-4" class="connector" />
    </svg>

    <header class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-0">RCA Forensic Analysis</h4>
            <div class="small text-muted mt-1">Context: <span id="ctx-id" class="badge bg-primary rounded-pill">Select App</span></div>
        </div>
        <div class="d-flex gap-2">
            <input type="text" id="searchInput" class="form-control form-control-sm" style="width:180px; border-radius:8px;" placeholder="App ID...">
            <button class="btn btn-sm btn-dark" style="border-radius:8px" onclick="performSearch()">Analyze</button>
        </div>
    </header>

    <div class="row g-3 justify-content-center">
        <div class="col-md-3">
            <div id="node-inc" class="apple-card p-3 text-center">
                <button class="collapse-btn" onclick="toggle('inc-details', this)"><i class="bi bi-chevron-down"></i></button>
                <div class="label">Incident</div>
                <div class="fw-bold text-primary" id="d-inc">---</div>
                <div id="inc-details" class="details-content">
                    <div class="label">Priority</div><div class="val" id="m-prio">-</div>
                    <div class="label">Group</div><div class="val" id="m-group">-</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div id="node-chg" class="apple-card p-3 text-center">
                <button class="collapse-btn" onclick="toggle('chg-details', this)"><i class="bi bi-chevron-down"></i></button>
                <div class="label">Change</div>
                <div class="fw-bold" id="d-chg">---</div>
                <div id="chg-details" class="details-content">
                    <div class="label">Risk</div><div class="val" id="m-risk">-</div>
                    <div class="label">Status</div><div class="val">Closed</div>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div id="node-ci" class="apple-card p-3">
                <button class="collapse-btn" onclick="toggle('ci-details', this)"><i class="bi bi-chevron-down"></i></button>
                <div class="label mb-2">Impacted CIs</div>
                <div id="ci-list"></div>
                <div id="ci-details" class="details-content">
                    <div class="row text-start">
                        <div class="col-6">
                            <div class="label">OS Version</div><div class="val" id="m-os">-</div>
                            <div class="label">Location</div><div class="val" id="m-loc">-</div>
                        </div>
                        <div class="col-6">
                            <div class="label">Environment</div><div class="val" id="m-env">-</div>
                            <div class="label">Asset Owner</div><div class="val" id="m-owner">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 justify-content-center mt-2">
        <div class="col-md-5">
            <div id="node-log" class="apple-card p-3 border-start border-danger border-4">
                <button class="collapse-btn" onclick="toggle('log-details', this)"><i class="bi bi-chevron-down"></i></button>
                <div class="label text-danger">Forensic Evidence</div>
                <div id="log-summary" class="fw-bold small mt-1">Select CI...</div>
                <div id="log-details" class="details-content">
                    <pre id="m-log"></pre>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div id="node-fix" class="apple-card p-3 border-start border-success border-4">
                <button class="collapse-btn" onclick="toggle('fix-details', this)"><i class="bi bi-chevron-down"></i></button>
                <div class="label text-success">Remediation Engine</div>
                <div class="fix-highlight mt-2" id="m-fix">Awaiting Analysis...</div>
                <div id="fix-details" class="details-content">
                    <div class="label">Resolution History</div>
                    <div id="m-past" class="small text-muted mb-2">---</div>
                    <button id="exec-btn" class="btn-execute" onclick="execute()">Run Automation</button>
                </div>
            </div>
        </div>
    </div>

    <div class="apple-card overflow-hidden mt-3">
        <table class="table table-sm mb-0 table-hover" style="font-size:0.8rem">
            <thead class="table-light"><tr><th>App ID</th><th>Incident</th><th>Summary</th></tr></thead>
            <tbody id="masterTable"></tbody>
        </table>
    </div>
</div>

<script>
    const dataRepo = [
        {
            app: 'APP-802', id: 'INC-4412', prio: 'P1', group: 'SRE-Web', chg: 'CHG-990', risk: 'Med',
            cis: [
                { 
                    name: 'WEB-SRV-01', os: 'Ubuntu 22', loc: 'US-East', env: 'Prod', owner: 'Web-Team',
                    log: '502 Bad Gateway: Upstream connection refused at 10.0.1.5:8080',
                    fix: 'Restart the listener service on port 8080 and verify health check.',
                    past: 'INC-330: Resolved by service restart.',
                    action: 'Restart Service'
                },
                { 
                    name: 'LB-FRONT-01', os: 'F5-BIGIP', loc: 'DC-Primary', env: 'Prod', owner: 'Net-Ops',
                    log: 'Pool Member WEB-SRV-01 marked DOWN: Health Check Failed',
                    fix: 'Check firewall rules between LB and Web-Srv.',
                    past: 'INC-112: Rule update required.',
                    action: 'Reset LB Connection'
                }
            ]
        },
        {
            app: 'APP-900', id: 'INC-5510', prio: 'P2', group: 'Database', chg: null, risk: 'N/A',
            cis: [
                { 
                    name: 'DB-MAIN-01', os: 'Postgres 14', loc: 'EU-West', env: 'Prod', owner: 'DBA',
                    log: 'FATAL: remaining connection slots are reserved for non-replication superuser connections',
                    fix: 'Increase max_connections parameter and reload configuration.',
                    past: 'INC-009: Resolved by connection pooling.',
                    action: 'Increase Conn Limit'
                }
            ]
        }
    ];

    function init() {
        const body = document.getElementById('masterTable');
        dataRepo.forEach((inc, idx) => {
            const tr = document.createElement('tr');
            if(idx === 0) tr.className = 'table-selected';
            tr.innerHTML = `<td><code>${inc.app}</code></td><td><b>${inc.id}</b></td><td>${inc.cis[0].name} error</td>`;
            tr.onclick = () => loadInc(tr, inc);
            body.appendChild(tr);
        });
        loadInc(null, dataRepo[0]);
    }

    function loadInc(row, inc) {
        if(row) {
            document.querySelectorAll('tr').forEach(r => r.classList.remove('table-selected'));
            row.classList.add('table-selected');
        }
        document.getElementById('ctx-id').innerText = inc.app;
        document.getElementById('d-inc').innerText = inc.id;
        document.getElementById('m-prio').innerText = inc.prio;
        document.getElementById('m-group').innerText = inc.group;
        
        const chgNode = document.getElementById('node-chg');
        if(!inc.chg) {
            chgNode.style.opacity = '0.3'; document.getElementById('d-chg').innerText = "N/A";
            document.getElementById('line-bypass').classList.remove('line-hidden');
            document.getElementById('line-1').classList.add('line-hidden');
            document.getElementById('line-2').classList.add('line-hidden');
        } else {
            chgNode.style.opacity = '1'; document.getElementById('d-chg').innerText = inc.chg;
            document.getElementById('m-risk').innerText = inc.risk;
            document.getElementById('line-bypass').classList.add('line-hidden');
            document.getElementById('line-1').classList.remove('line-hidden');
            document.getElementById('line-2').classList.remove('line-hidden');
        }

        const list = document.getElementById('ci-list');
        list.innerHTML = '';
        inc.cis.forEach(ci => {
            const d = document.createElement('div');
            d.className = 'ci-item';
            d.innerHTML = `<span>${ci.name}</span> <i class="bi bi-chevron-right small"></i>`;
            d.onclick = (e) => { e.stopPropagation(); selectCI(d, ci); };
            list.appendChild(d);
        });
        draw();
    }

    function selectCI(el, ci) {
        document.querySelectorAll('.ci-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('m-os').innerText = ci.os;
        document.getElementById('m-loc').innerText = ci.loc;
        document.getElementById('m-env').innerText = ci.env;
        document.getElementById('m-owner').innerText = ci.owner;
        document.getElementById('log-summary').innerText = ci.name;
        document.getElementById('m-log').innerText = ci.log;
        document.getElementById('m-fix').innerText = ci.fix;
        document.getElementById('m-past').innerText = ci.past;
        document.getElementById('exec-btn').innerText = "Run: " + ci.action;
        
        document.getElementById('ci-details').classList.add('expanded');
        document.getElementById('log-details').classList.add('expanded');
        document.getElementById('fix-details').classList.add('expanded');
        draw();
    }

    function execute() {
        const b = document.getElementById('exec-btn');
        b.innerText = "Processing..."; b.style.background = "#000";
        setTimeout(() => { b.innerText = "Success"; b.style.background = "#24b244"; }, 1200);
    }

    function toggle(id, btn) {
        document.getElementById(id).classList.toggle('expanded');
        const icon = btn.querySelector('i');
        icon.className = icon.className.includes('down') ? 'bi bi-chevron-up' : 'bi bi-chevron-down';
        let c = 0; let itv = setInterval(() => { draw(); if(c++ > 15) clearInterval(itv); }, 30);
    }

    function draw() {
        const cont = document.getElementById('main-canvas').getBoundingClientRect();
        const box = (id) => {
            const r = document.getElementById(id).getBoundingClientRect();
            return { x: r.left - cont.left, y: r.top - cont.top, w: r.width, h: r.height, cx: r.left - cont.left + (r.width / 2), cy: r.top - cont.top + (r.height / 2) };
        };
        const i = box('node-inc'); const h = box('node-chg'); const c = box('node-ci'); const l = box('node-log'); const f = box('node-fix');

        document.getElementById('line-1').setAttribute('d', `M ${i.x + i.w} ${i.cy} L ${h.x} ${h.cy}`);
        document.getElementById('line-2').setAttribute('d', `M ${h.x + h.w} ${h.cy} L ${c.x} ${c.cy}`);
        document.getElementById('line-bypass').setAttribute('d', `M ${i.x + i.w} ${i.cy} C ${i.x + i.w + 40} ${i.cy}, ${c.x - 40} ${c.cy}, ${c.x} ${c.cy}`);
        document.getElementById('line-3').setAttribute('d', `M ${c.cx} ${c.y + c.h} C ${c.cx} ${c.y + c.h + 20}, ${l.cx} ${l.y - 20}, ${l.cx} ${l.y}`);
        document.getElementById('line-4').setAttribute('d', `M ${l.x + l.w} ${l.cy} L ${f.x} ${f.cy}`);
    }

    function performSearch() {
        const val = document.getElementById('searchInput').value;
        if(val) document.getElementById('ctx-id').innerText = val;
    }

    window.onload = () => { init(); setTimeout(draw, 300); };
    window.onresize = draw;
</script>
</body>
</html>